# 🔍 PSD图层导入调试指南

## 问题诊断

当PSD编辑区显示与预览区不一致时，通过以下步骤诊断：

### 1. 开启浏览器开发者工具

1. 按 `F12` 或右键选择"检查元素"
2. 切换到 "Console" 标签页
3. 重新上传PSD文件，观察控制台输出

### 2. 关键日志信息

查找以下类型的日志消息：

#### 📁 图层处理日志
```
处理图层组: [图层组名], 子图层数: [数量]
添加图层: [图层名], 类型: [文字/图像/其他]
```

#### 🎯 元素创建日志
```
创建元素: [图层名], 位置: (x, y), 尺寸: 宽x高, 可见: true/false
✅ 高质量图像图层创建: [图层名], 尺寸: 宽x高, 格式: image/png
⚠️  图层 [图层名] 无图像内容，创建占位符
```

#### ❌ 错误日志
```
跳过空图层: [图层名] (无有效内容)
图层转换失败: [错误信息]
无法创建图层 Canvas，跳过图层: [图层名]
```

### 3. 图层导入状态检查

#### 成功导入的图层应该显示：
- ✅ 图层名称
- ✅ 正确的位置坐标
- ✅ 正确的尺寸
- ✅ 可见性状态

#### 问题图层可能显示：
- ⚠️ 跳过空图层
- ❌ 图层转换失败
- 🔄 尺寸不匹配警告

### 4. 常见问题及解决方案

#### 问题1: 大量图层被跳过
**症状**: 控制台显示大量"跳过空图层"或"跳过隐藏图层"
**原因**: 图层过滤过于严格
**解决**: 已优化图层过滤逻辑，现在会导入更多图层

#### 问题2: 图层位置不正确
**症状**: 元素位置与PSD预览不匹配
**原因**: 坐标系统转换问题
**解决**: 已改进坐标计算逻辑

#### 问题3: 图层组内容丢失
**症状**: 只看到少数图层，图层组内容消失
**原因**: 图层组处理逻辑错误
**解决**: 已修复图层组递归处理

#### 问题4: 图像质量问题
**症状**: 图像模糊或像素化
**原因**: Canvas渲染质量设置
**解决**: 已实施高质量渲染和超采样

### 5. 手动调试步骤

#### 步骤1: 检查PSD文件结构
```javascript
// 在控制台中运行
console.log('PSD Children:', window.lastPSD?.children);
```

#### 步骤2: 检查图层扁平化结果
```javascript
// 检查扁平化后的图层数量
console.log('Flattened Layers Count:', window.lastFlattenedLayers?.length);
```

#### 步骤3: 检查Polotno元素
```javascript
// 检查当前页面的元素
console.log('Current Elements:', window.store?.activePage?.children.toJSON());
```

### 6. 导入设置优化

#### 推荐设置：
- ✅ 选择"导入为可编辑文字"以获得最佳编辑体验
- ✅ 如果图层缺失，尝试"导入为图片"模式
- ✅ 检查PSD文件是否包含合并图层

#### PSD文件要求：
- 📝 保持图层未合并状态
- 📝 避免过于复杂的图层结构（深度嵌套）
- 📝 确保图层有明确的边界和内容
- 📝 避免空白或透明度100%的图层

### 7. 性能监控

监控以下指标：
- 📊 导入成功率: `成功图层数 / 总图层数`
- 📊 处理时间: 从上传到完成的总时间
- 📊 内存使用: 大型PSD文件的内存占用

### 8. 故障报告

如果问题持续存在，请提供：

1. **PSD文件信息**
   - 文件大小
   - 图层总数
   - 文字图层数量
   - 图像图层数量

2. **控制台日志**
   - 完整的错误消息
   - 图层处理日志
   - 性能警告

3. **浏览器信息**
   - 浏览器类型和版本
   - 操作系统
   - 屏幕分辨率

---

## 最新改进 (v2.0)

### ✅ 已修复的问题：
1. **图层过滤优化**: 不再跳过隐藏但有内容的图层
2. **图层组处理**: 正确递归处理图层组结构
3. **坐标计算**: 改进位置和尺寸计算精度
4. **透明度处理**: 保持原始透明度设置
5. **图像质量**: 超高清渲染和超采样技术
6. **错误处理**: 更详细的日志和占位符机制

### 🔄 当前版本特性：
- 智能图层识别和分类
- 高质量图像渲染
- 完整的图层效果支持
- 详细的调试日志输出
- 占位符机制防止图层丢失

现在重新上传PSD文件，应该能看到更完整和准确的图层导入结果！